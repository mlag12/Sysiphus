<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sísifo na Montanha — Versão Mobile com Slider Aprimorado</title>
    <style>
        :root {
            --btn-bg: linear-gradient(135deg, #ff004d, #ffb347);
            --btn-border: #000;
            --accent: #ff004d;
            --neon: #00ffff;
            --slider-track-bg: rgba(255, 255, 255, 0.2);
            --slider-handle-bg: #ff004d;
            --slider-handle-active-bg: #ffb347;
            --background-filter: none; /* Default filter for background */
            --sisifo-rock-filter: none; /* Default filter for Sisifo's rock */
        }

        body.dark-mode {
            background: #1a1a1a; /* Darker background */
            color: #e0e0e0; /* Lighter text color */
        }

        body.dark-mode #placar {
            color: #f0f0f0;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);
        }

        body.dark-mode #slider-container {
            background: rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.2);
        }

        body.dark-mode #slider-handle {
            background: #8e0030;
        }

        body.dark-mode #slider-handle.active {
            background: #b33d00;
        }

        body.dark-mode #menu-itens button,
        body.dark-mode #menu-itens label,
        body.dark-mode #botao-menu {
            background: linear-gradient(135deg, #4d001e, #663300);
            border-color: #333;
            color: #e0e0e0;
        }

        body.dark-mode #ranking-absurdo {
            background: rgba(20, 20, 20, 0.95);
            border: 4px dashed #440011; /* Darker red border */
            box-shadow: 0 0 20px rgba(100,0,30,0.5);
        }

        body.dark-mode #ranking-absurdo h1 {
            color: #cc0033; /* Darker accent red */
            text-shadow: 2px 2px 6px rgba(100, 0, 30, 0.5);
            border-bottom-color: #663300;
        }

        body.dark-mode #ranking-list li {
            color: #008888;
            text-shadow: 1px 1px 3px rgba(0, 50, 50, 0.4);
        }

        body.dark-mode .caixa-nome {
            background: linear-gradient(45deg, #550055, #005555);
            border-color: #666600;
            box-shadow: 0 0 20px rgba(0, 80, 80, 0.5);
        }

        body.dark-mode .caixa-nome input {
            background-color: rgba(0, 0, 0, 0.7);
            color: #e0e0e0;
            border-color: #555;
        }

        body.dark-mode .caixa-nome button {
            background: linear-gradient(135deg, #4d001e, #663300);
            border-color: #333;
            color: #e0e0e0;
        }

        /* reset mínimo */
        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: #000;
            color: #fff;
            font-family: "Courier New", monospace;
            overflow: hidden; /* Evita barras de rolagem */
            transition: background-color 0.3s ease; /* Smooth transition for dark mode */
        }

        /* canvas full screen */
        #game {
            display: block;
            width: 100vw;
            height: 100vh;
            background: #000;
        }

        /* UI overlay */
        #ui {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 100;
        }

        #placar {
            position: absolute;
            top: 2%;
            left: 2%;
            color: #fff;
            font-weight: 800;
            font-size: 3vh;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);
            z-index: 110;
            white-space: nowrap;
        }

        /* Container para o Slider */
        #slider-container {
            position: fixed;
            bottom: 3%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 120;
            pointer-events: auto;
            width: 60%; /* Largura do slider diminuída para 60% */
            max-width: 400px; /* Largura máxima em telas grandes também diminuída */
            height: 60px; /* Altura da área do slider */
            background: var(--slider-track-bg);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        #slider-handle {
            position: absolute;
            width: 50px; /* Tamanho do handle do slider */
            height: 50px;
            background: var(--slider-handle-bg);
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #slider-handle.active {
            background: var(--slider-handle-active-bg);
            transform: scale(1.1);
        }

        /* Menu e Ranking */
        #menu-container {
            position: fixed;
            top: 2%;
            right: 2%;
            z-index: 130;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        #botao-menu {
            cursor: pointer;
            font-size: 16px;
            background: var(--btn-bg);
            border: 2px solid #000;
            padding: 6px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: #fff; /* Adicionado para garantir a cor do texto */
        }

        #menu-itens {
            display: none;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
            margin-top: 4px;
        }

        #menu-container.open #menu-itens {
            display: flex;
        }

        #menu-itens button,
        #menu-itens label {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            cursor: pointer;
            font-size: 15px;
            background: var(--btn-bg);
            border: 2px solid #000;
            padding: 8px 12px;
            border-radius: 8px;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: #fff; /* Adicionado para garantir a cor do texto */
        }

        #menu-itens label input {
            margin-left: 0;
            transform: scale(1.1);
        }

        /* Ranking Modal */
        #ranking-absurdo {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(2deg);
            padding: 5vh 8vw;
            background: rgba(0, 0, 0, 0.95);
            border: 4px dashed red;
            color: white;
            font-family: "Courier New", monospace;
            font-size: 3.5vh;
            text-align: center;
            z-index: 1000;
            max-height: 80vh; /* Aumentado para caber o Top 10 */
            overflow-y: auto;
            min-width: 300px; /* Ajustado para melhor visualização em telas menores */
            width: auto;
            white-space: nowrap;
            box-shadow: 0 0 20px rgba(255,0,77,0.5);
        }

        #ranking-absurdo h1 {
            font-family: Impact, fantasy;
            font-size: 6vh;
            color: var(--accent);
            text-shadow: 2px 2px 6px rgba(255, 0, 77, 0.5);
            margin-bottom: 2vh;
            border-bottom: 2px dashed yellow;
            padding-bottom: 1vh;
        }

        #ranking-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #ranking-list li {
            margin-bottom: 1.2vh;
            color: var(--neon);
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0, 255, 255, 0.4);
        }

        /* Name Input Box */
        .caixa-nome {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-5deg);
            padding: 5vh 8vw;
            background: linear-gradient(45deg, #ff00ff, #00ffff);
            border: 4px dashed yellow;
            color: white;
            font-family: "Courier New", monospace;
            font-size: 4.5vh;
            text-align: center;
            z-index: 999;
            width: 80%; /* Ocupa 80% da largura */
            max-width: 400px; /* Largura máxima para não ficar muito grande */
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            border-radius: 10px;
        }

        .caixa-nome p {
            line-height: 1.5;
        }

        .caixa-nome input {
            font-size: 3vh;
            padding: 12px;
            width: 100%;
            border-radius: 8px;
            border: 2px solid #000;
            margin-top: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
        }

        .caixa-nome button {
            margin-top: 16px;
            font-size: 2.8vh;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            background: var(--btn-bg);
            border: 2px solid var(--btn-border);
            color: #fff;
            font-weight: 900;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <canvas id="game"></canvas>

    <div id="ui">
        <div id="placar">Montanhas: 0</div>

        <div id="slider-container">
            <div id="slider-handle"></div>
        </div>

        <div id="menu-container">
            <button id="botao-menu">Menu</button>
            <div id="menu-itens">
                <button id="botao-ranking">Ranking</button>
                <label><input type="checkbox" id="mostrar-score"> Mostrar Score</label>
                <label><input type="checkbox" id="dark-mode-toggle"> Modo Escuro</label>
                <label><input type="checkbox" id="music-toggle"> Música</label>
            </div>
        </div>

        <div id="ranking-absurdo">
            <h1>TOP 10:</h1>
            <ul id="ranking-list"></ul>
        </div>
    </div>

    <script type="module">
        // --------------------------
        // Firebase v10 (Firestore)
        // --------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            query,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // === Firebase configuration - mantenha a sua informação aqui ===
        const firebaseConfig = {
            apiKey: "AIzaSyAk2SE580mZCNbLpAboxC7A4FlviilKtIE",
            authDomain: "sysiphus-afea7.firebaseapp.com",
            projectId: "sysiphus-afea7",
            storageBucket: "sysiphus-afea7.firebasestorage.app",
            messagingSenderId: "182996428651",
            appId: "1:182996428651:web:82675bca0f31c978db8e2e",
            measurementId: "G-G6N5MKSFV3"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Referência para a coleção de scores
        const scoresCollection = collection(db, "scores");

        // --------------------------
        // Elementos DOM
        // --------------------------
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const placarEl = document.getElementById('placar');

        // Slider Elements
        const sliderContainer = document.getElementById('slider-container');
        const sliderHandle = document.getElementById('slider-handle');

        const botaoMenu = document.getElementById('botao-menu');
        const menuContainer = document.getElementById('menu-container');
        const botaoRanking = document.getElementById('botao-ranking');
        const rankingBox = document.getElementById('ranking-absurdo');
        const rankingList = document.getElementById('ranking-list');
        const checkboxMostrarScore = document.getElementById('mostrar-score');
        const checkboxDarkMode = document.getElementById('dark-mode-toggle');
        const checkboxMusic = document.getElementById('music-toggle'); // Checkbox de Música


        // --------------------------
        // Imagens (coloque na pasta images)
        // --------------------------
        const IMG_BG = new Image(); IMG_BG.src = 'images/montanha.jpg';
        const IMG_SISIFO = new Image(); IMG_SISIFO.src = 'images/sisifo.png';
        const IMG_PEDRA = new Image(); IMG_PEDRA.src = 'images/pedra.png';

        // --------------------------
        // Estado do jogo
        // --------------------------
        const ESTADOS = { PARADO: 0, SUBINDO: 1, PAUSA: 2, QUEDA: 3, SUICIDIO: 4 };
        let estado = ESTADOS.PARADO;
        let montanhas = 0;
        let mostrarScore = false;
        let darkModeAtivo = false;
        let musicaAtiva = false; // Estado para a música

        // Áudio da música
        const musicaPedra = new Audio('sound/If You Hold A Stone.mp3');
        musicaPedra.loop = true; // Para a música tocar em loop
        musicaPedra.volume = 0.5; // Volume inicial da música (ajuste se necessário)

        // Estado do Slider
        let isSliderDragging = false;
        let sliderRelativeX = 0.5; // Posição horizontal do slider (0 a 1)
        let characterOffsetX = 0; // Deslocamento horizontal do personagem

        checkboxMostrarScore.addEventListener('change', () => { mostrarScore = checkboxMostrarScore.checked; });
        botaoMenu.addEventListener('click', () => menuContainer.classList.toggle('open'));

        checkboxDarkMode.addEventListener('change', () => {
            darkModeAtivo = checkboxDarkMode.checked;
            document.body.classList.toggle('dark-mode', darkModeAtivo);
            localStorage.setItem('darkModePreference', darkModeAtivo);
        });

        checkboxMusic.addEventListener('change', () => {
            musicaAtiva = checkboxMusic.checked;
            if (musicaAtiva) {
                // Tenta tocar a música, pode precisar de interação do usuário primeiro
                musicaPedra.play().catch(error => {
                    console.log("Reprodução automática de música bloqueada:", error);
                    // Se bloqueado, a música só tocará após o primeiro toque no slider
                });
            } else {
                musicaPedra.pause();
            }
            localStorage.setItem('musicPreference', musicaAtiva);
        });

        // Carregar preferências salvas
        const savedDarkMode = localStorage.getItem('darkModePreference');
        if (savedDarkMode !== null) {
            darkModeAtivo = JSON.parse(savedDarkMode);
            checkboxDarkMode.checked = darkModeAtivo;
            document.body.classList.toggle('dark-mode', darkModeAtivo);
        }

        const savedMusic = localStorage.getItem('musicPreference');
        if (savedMusic !== null) {
            musicaAtiva = JSON.parse(savedMusic);
            checkboxMusic.checked = musicaAtiva;
            if (musicaAtiva) {
                musicaPedra.play().catch(error => { /* Ignora erro se bloqueado inicialmente */ });
            }
        }


        botaoRanking.addEventListener('click', () => {
            const isShown = rankingBox.style.display === 'block';
            rankingBox.style.display = isShown ? 'none' : 'block';
            if (!isShown) atualizarRanking();
        });

        // --------------------------
        // novas pedras caindo durante subida
        // --------------------------
        const pedrasCaindo = [];
        const PEDRA_CAI_W = 40; // largura padrão
        const PEDRA_CAI_H = 40; // altura padrão
        const NUM_PEDRAS_POR_GERACAO = 6;
        const VELOCIDADE_PEDRA_MIN = 10; // Aumentada
        const VELOCIDADE_PEDRA_MAX = 15; // Aumentada
        const FREQUENCIA_GERACAO_PEDRA = 0.025; 

        // --- resize canvas & curves ---
        const curvaSubidaPct = [{ x: 0.15, y: 0.65 }, { x: 0.25, y: 0.40 }, { x: 0.40, y: 0.40 }, { x: 0.60, y: 0.40 }];
        const curvaQuedaPct = [{ x: 0.70, y: 0.40 }, { x: 0.75, y: 0.55 }, { x: 0.90, y: 0.65 }, { x: 0.99, y: 0.75 }];
        let curvaSubida, curvaQueda;

        function pctToPx(curva) { return curva.map(p => ({ x: p.x * canvas.width, y: p.y * canvas.height })); }

        function resize() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            curvaSubida = pctToPx(curvaSubidaPct); curvaQueda = pctToPx(curvaQuedaPct);
            updateSliderHandlePosition(sliderRelativeX);
        }
        window.addEventListener('resize', resize); resize();

        // --- Controles do Slider ---
        function getTouchPosition(event) {
            const touch = event.touches ? event.touches[0] : event;
            const rect = sliderContainer.getBoundingClientRect();
            return {
                x: touch.clientX - rect.left,
                y: touch.clientY - rect.top
            };
        }

        function updateSliderHandlePosition(relativeX) {
            const sliderWidth = sliderContainer.clientWidth;
            const handleWidth = sliderHandle.clientWidth;
            const minHandleX = handleWidth / 2;
            const maxHandleX = sliderWidth - handleWidth / 2;

            const handleX = minHandleX + (maxHandleX - minHandleX) * relativeX;
            sliderHandle.style.left = `${handleX - handleWidth / 2}px`;

            const maxCharacterOffset = sliderWidth * 0.4;
            characterOffsetX = (sliderRelativeX - 0.5) * 2 * maxCharacterOffset;
        }

        function onSliderStart(event) {
            if (estado !== ESTADOS.SUBINDO && estado !== ESTADOS.PARADO) return;

            event.preventDefault();
            isSliderDragging = true;
            sliderHandle.classList.add('active');
            
            if (estado === ESTADOS.PARADO) {
                iniciarCiclo();
                if (musicaAtiva) {
                    musicaPedra.play().catch(error => console.log("Erro ao tocar música:", error));
                }
            }
        }

        function onSliderMove(event) {
            if (!isSliderDragging || estado !== ESTADOS.SUBINDO) return; 
            event.preventDefault();
            const pos = getTouchPosition(event);
            const sliderWidth = sliderContainer.clientWidth;
            const handleWidth = sliderHandle.clientWidth;

            const newRelativeX = (pos.x - handleWidth / 2) / (sliderWidth - handleWidth);
            sliderRelativeX = clamp(newRelativeX, 0, 1);

            updateSliderHandlePosition(sliderRelativeX);
        }

        function onSliderEnd(event) {
            event.preventDefault();
            isSliderDragging = false;
            sliderHandle.classList.remove('active');
        }

        sliderContainer.addEventListener('touchstart', onSliderStart, { passive: false });
        sliderContainer.addEventListener('touchmove', onSliderMove, { passive: false });
        sliderContainer.addEventListener('touchend', onSliderEnd, { passive: false });
        sliderContainer.addEventListener('touchcancel', onSliderEnd, { passive: false });

        sliderContainer.addEventListener('mousedown', onSliderStart, { passive: false });
        document.addEventListener('mousemove', onSliderMove, { passive: false });
        document.addEventListener('mouseup', onSliderEnd);
        document.addEventListener('mouseleave', onSliderEnd);

        // --- movimento / física ---
        function cubicBezierPoint(t, p0, p1, p2, p3) {
            const lerp = (a, b, t) => ({ x: a.x + (b.x - a.x) * t, y: a.y + (b.y - a.y) * t });
            const a = lerp(p0, p1, t), b = lerp(p1, p2, t), c = lerp(p2, p3, t);
            const d = lerp(a, b, t), e = lerp(b, c, t);
            return lerp(d, e, t);
        }

        let progressoSubida = 0, velSubida = 0;
        let maxVelSubida = 0.01, aceleracaoSubida = 0.0005;
        let progressoQueda = 0, velQueda = 0;
        let aceleracaoQuedaInit = 0.008, gravidadeQueda = 0.0002, pausaFrames = 0;

        function iniciarCiclo() {
            estado = ESTADOS.SUBINDO;
            progressoSubida = 0;
            velSubida = 0.005;
            progressoQueda = 0;
            velQueda = 0;
            pedrasCaindo.length = 0;
            sliderRelativeX = 0.5;
            characterOffsetX = 0;
            updateSliderHandlePosition(sliderRelativeX);
            placarEl.textContent = `Montanhas: ${montanhas}`;
            console.log("Iniciando novo ciclo!");
        }

        function reiniciarParaParado() {
            montanhas++;
            estado = ESTADOS.PARADO;
            progressoSubida = 0;
            progressoQueda = 0;
            velSubida = 0;
            velQueda = 0;
            pedrasCaindo.length = 0;
            sliderRelativeX = 0.5;
            characterOffsetX = 0;
            updateSliderHandlePosition(sliderRelativeX);
            placarEl.textContent = `Montanhas: ${montanhas}`;
            console.log(`Ciclo concluído. Montanhas: ${montanhas}`);
        }

        function gerarPedraCaindo(xPersonagem, wPersonagem) {
            for (let i = 0; i < NUM_PEDRAS_POR_GERACAO; i++) {
                let x;
                const zonaExclusao = canvas.width * 0.2;
                do {
                    x = Math.random() * (canvas.width - PEDRA_CAI_W);
                } while (Math.abs(x - (xPersonagem + wPersonagem / 2)) < zonaExclusao);

                const y = -PEDRA_CAI_H - (i * PEDRA_CAI_H * 0.5);
                const velocidade = VELOCIDADE_PEDRA_MIN + Math.random() * (VELOCIDADE_PEDRA_MAX - VELOCIDADE_PEDRA_MIN);
                pedrasCaindo.push({ x, y, velocidade });
            }
        }

        function atualizarPedrasCaindo(xPersonagem, yPersonagem, wPersonagem, hPersonagem) {
            for (let i = pedrasCaindo.length - 1; i >= 0; i--) {
                const ped = pedrasCaindo[i];
                ped.y += ped.velocidade;
                
                ctx.save();
                if (darkModeAtivo) {
                    ctx.filter = 'brightness(1.2) hue-rotate(-40deg) saturate(3) sepia(0.5)';
                } else {
                    ctx.filter = 'none';
                }
                if (IMG_PEDRA.complete) {
                    ctx.drawImage(IMG_PEDRA, ped.x, ped.y, PEDRA_CAI_W, PEDRA_CAI_H);
                }
                ctx.restore();

                if (
                    ped.x < xPersonagem + wPersonagem &&
                    ped.x + PEDRA_CAI_W > xPersonagem &&
                    ped.y < yPersonagem + hPersonagem &&
                    ped.y + PEDRA_CAI_H > yPersonagem
                ) {
                    pedrasCaindo.splice(i, 1);
                    fimDoJogoSuicidio();
                    return;
                }
                if (ped.y > canvas.height) {
                    pedrasCaindo.splice(i, 1);
                }
            }
        }

        // --------------------------
        // FIREBASE: salvar apenas se entra no top10
        // --------------------------
        async function salvarScoreSeTop10(nome, score) {
            try {
                const top10Query = query(scoresCollection, orderBy("score", "desc"), limit(10));
                const snapshot = await getDocs(top10Query);
                let top10 = [];
                snapshot.forEach(doc => {
                    top10.push({ id: doc.id, ...doc.data() });
                });

                const lastScore = top10.length > 0 ? top10[top10.length - 1].score : -Infinity;
                const entrou = top10.length < 10 || score >= lastScore;

                if (entrou) {
                    await addDoc(scoresCollection, {
                        name: nome || "Anônimo",
                        score: Number(score),
                        createdAt: new Date()
                    });
                }
                return entrou;
            } catch (err) {
                console.error("Erro ao salvar score:", err);
                return false;
            }
        }

        // --------------------------
        // Atualiza ranking exibido (top 10) a partir do Firestore
        // --------------------------
        async function atualizarRanking() {
            try {
                const top10Query = query(scoresCollection, orderBy("score", "desc"), limit(10));
                const snapshot = await getDocs(top10Query);

                rankingList.innerHTML = '';
                const scores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    scores.push({ nome: data.name || 'Anônimo', score: Number(data.score) || 0 });
                });

                if (scores.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'Ainda não há scores.';
                    rankingList.appendChild(li);
                    return;
                }

                scores.forEach((s, i) => {
                    const li = document.createElement('li');
                    li.textContent = `${i + 1}. ${s.nome} - ${s.score}`;
                    rankingList.appendChild(li);
                });
            } catch (err) {
                console.error("Erro ao atualizar ranking:", err);
            }
        }

        // --------------------------
        // fim do jogo suicídio: pede nome e tenta salvar
        // --------------------------
        let caixaNomeElement = null;
        let lastTopScore = 0; // Para verificar se a pontuação é >= ao último colocado

        async function fimDoJogoSuicidio() {
            const scoreAtual = montanhas;
            estado = ESTADOS.PARADO;
            isSliderDragging = false;
            sliderHandle.classList.remove('active');
            sliderRelativeX = 0.5;
            characterOffsetX = 0;
            updateSliderHandlePosition(sliderRelativeX);

            if (musicaAtiva) musicaPedra.pause();

            // Verifica se a pontuação é suficiente para entrar no ranking
            const top10Query = query(scoresCollection, orderBy("score", "desc"), limit(10));
            const snapshot = await getDocs(top10Query);
            const scores = [];
            snapshot.forEach(doc => {
                scores.push(doc.data());
            });
            lastTopScore = scores.length > 0 ? scores[scores.length - 1].score : -Infinity;

            if (scoreAtual >= lastTopScore || scores.length < 10) {
                 mostrarCaixaNome(scoreAtual);
            } else {
                 resetarJogoAposGameOver();
            }
        }

        function mostrarCaixaNome(scoreAtual) {
            if (caixaNomeElement) return; // Já está visível

            caixaNomeElement = document.createElement('div');
            caixaNomeElement.className = 'caixa-nome';
            caixaNomeElement.innerHTML = `
                <p>Você atingiu <strong>${scoreAtual}</strong> montanhas!</p>
                <p>Insira seu nome para o ranking:</p>
                <input type="text" id="nome-jogador" placeholder="Seu nome..." />
                <div style="margin-top:16px">
                    <button id="salvar-absurdo">Salvar</button>
                    <button id="cancelar-absurdo" style="margin-left:10px;">Cancelar</button>
                </div>
            `;
            document.body.appendChild(caixaNomeElement);
            document.getElementById('nome-jogador').focus();

            document.getElementById('salvar-absurdo').addEventListener('click', async () => {
                const nome = document.getElementById('nome-jogador').value.trim() || 'Anônimo';
                await salvarScoreSeTop10(nome, scoreAtual);
                esconderCaixaNome();
                resetarJogoAposGameOver();
            });

            document.getElementById('cancelar-absurdo').addEventListener('click', () => {
                esconderCaixaNome();
                resetarJogoAposGameOver();
            });
        }

        function esconderCaixaNome() {
            if (caixaNomeElement && caixaNomeElement.parentNode) {
                caixaNomeElement.parentNode.removeChild(caixaNomeElement);
                caixaNomeElement = null;
            }
        }

        function resetarJogoAposGameOver() {
            montanhas = 0;
            estado = ESTADOS.PARADO;
            progressoSubida = 0;
            progressoQueda = 0;
            velSubida = 0;
            velQueda = 0;
            pedrasCaindo.length = 0;
            placarEl.textContent = `Montanhas: ${montanhas}`;
            sliderRelativeX = 0.5;
            characterOffsetX = 0;
            updateSliderHandlePosition(sliderRelativeX);
            atualizarRanking();
            if (musicaAtiva) {
                musicaPedra.currentTime = 0; // Reinicia a música do começo
                musicaPedra.play().catch(error => console.log("Erro ao tocar música:", error));
            }
        }

        // --------------------------
        // desenho de fundo otimizado
        // --------------------------
        function desenharFundo() {
            if (!IMG_BG.complete) return;

            ctx.save();
            if (darkModeAtivo) {
                ctx.filter = 'brightness(0.6) contrast(1.1) grayscale(0.2)'; 
            } else {
                ctx.filter = 'none';
            }

            const scaleX = canvas.width / IMG_BG.width;
            const scaleY = canvas.height / IMG_BG.height;
            const scale = Math.min(scaleX, scaleY);

            const w = IMG_BG.width * scale;
            const h = IMG_BG.height * scale;

            const offsetX = (canvas.width - w) / 2;
            const offsetY = (canvas.height - h) / 2;

            ctx.drawImage(IMG_BG, offsetX, offsetY, w, h);
            ctx.restore();
        }

        // --------------------------
        // loop principal e renderização detalhada
        // --------------------------
        function loop() {
            if (estado === ESTADOS.SUBINDO) {
                velSubida += aceleracaoSubida;
                velSubida = clamp(velSubida, 0, maxVelSubida);

                progressoSubida += velSubida;
                progressoSubida = clamp(progressoSubida, 0, 1);

                if (progressoSubida >= 1) {
                    estado = ESTADOS.PAUSA;
                    pausaFrames = 15;
                    progressoQueda = 0;
                    velQueda = aceleracaoQuedaInit;
                }
            } else if (estado === ESTADOS.PAUSA) {
                pausaFrames--;
                if (pausaFrames <= 0) estado = ESTADOS.QUEDA;
            } else if (estado === ESTADOS.QUEDA) {
                velQueda += gravidadeQueda;
                progressoQueda += velQueda;
                progressoQueda = clamp(progressoQueda, 0, 1);
                if (progressoQueda >= 1) {
                    reiniciarParaParado();
                }
            } else if (estado === ESTADOS.SUICIDIO) {
                velQueda += gravidadeQueda;
                progressoQueda += velQueda;
                progressoQueda = clamp(progressoQueda, 0, 1);
                if (progressoQueda >= 1) {
                    estado = ESTADOS.PARADO;
                    fimDoJogoSuicidio();
                }
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            desenharFundo();

            const pSisBase = cubicBezierPoint(progressoSubida, ...curvaSubida);
            const pQueda = cubicBezierPoint(progressoQueda, ...curvaQueda);

            const sisW = canvas.width * 0.12; const sisH = sisW * (IMG_SISIFO.height / IMG_SISIFO.width || 1);
            const pedW = sisW * 0.7; const pedH = pedW;

            if (estado === ESTADOS.SUICIDIO) {
                const q = pQueda;
                const sisDesvio = Math.sin(progressoQueda * Math.PI * 0.5) * (canvas.width * 0.04);
                const sx = q.x - sisW / 2 + sisDesvio; const sy = q.y - sisH / 2;
                if (IMG_SISIFO.complete) ctx.drawImage(IMG_SISIFO, sx, sy, sisW, sisH);

                const px = q.x - pedW / 2 + Math.cos(progressoQueda * Math.PI * 1.5) * (canvas.width * 0.035);
                const py = q.y - pedH / 2;
                ctx.save();
                if (darkModeAtivo) {
                    ctx.filter = 'brightness(1.2) hue-rotate(-40deg) saturate(3) sepia(0.5)';
                }
                ctx.translate(px + pedW / 2, py + pedH / 2); ctx.rotate(progressoQueda * Math.PI * 1.5); if (IMG_PEDRA.complete) ctx.drawImage(IMG_PEDRA, -pedW / 2, -pedH / 2, pedW, pedH); ctx.restore();

            } else {
                const s = pSisBase;
                const sx = s.x - sisW / 2 + characterOffsetX;
                const sy = s.y - sisH + (canvas.height * 0.01);
                if (IMG_SISIFO.complete) ctx.drawImage(IMG_SISIFO, sx, sy, sisW, sisH);

                if (estado === ESTADOS.SUBINDO || estado === ESTADOS.PAUSA) {
                    const pedX = sx + sisW * 0.4;
                    const pedY = sy - pedH * 0.7;
                    ctx.save();
                    if (darkModeAtivo) {
                        ctx.filter = 'brightness(1.2) hue-rotate(-40deg) saturate(3) sepia(0.5)';
                    }
                    if (IMG_PEDRA.complete) ctx.drawImage(IMG_PEDRA, pedX, pedY, pedW, pedH);
                    ctx.restore();
                }

                if (estado === ESTADOS.SUBINDO) {
                    if (Math.random() < FREQUENCIA_GERACAO_PEDRA) {
                        gerarPedraCaindo(sx, sisW);
                    }
                    atualizarPedrasCaindo(sx, sy, sisW, sisH);
                }

                if (estado === ESTADOS.QUEDA) {
                    const q = pQueda;
                    const px = q.x - pedW / 2; const py = q.y - pedH / 2;
                    ctx.save();
                    if (darkModeAtivo) {
                        ctx.filter = 'brightness(1.2) hue-rotate(-40deg) saturate(3) sepia(0.5)';
                    }
                    ctx.translate(px + pedW / 2, py + pedH / 2); ctx.rotate(progressoQueda * Math.PI * 3.6); if (IMG_PEDRA.complete) ctx.drawImage(IMG_PEDRA, -pedW / 2, -pedH / 2, pedW, pedH); ctx.restore();
                }
            }

            if (mostrarScore) placarEl.textContent = '';
            else placarEl.textContent = `Montanhas: ${montanhas}`;

            requestAnimationFrame(loop);
        }

        requestAnimationFrame(loop);
        atualizarRanking();

        window._game = { reiniciarParaParado, iniciarCiclo, atualizarRanking };

        function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
        function safeNumber(v, fallback = 0) { const n = Number(v); return Number.isNaN(n) ? fallback : n; }
    </script>
</body>
</html>
